name: Quick Redeploy - Casino Bot Only

on:
  push:
    branches:
      - main
    paths:
      - 'casino/*.py'
      - 'casino/casino-requirements.txt'
  workflow_dispatch:

jobs:
  redeploy-bot:
    name: Rebuild & Restart Casino Bot Only
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Start SSH Agent & Add Key
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: SSH and Rebuild Casino Bot
      env:
        SSH_USER: ${{ secrets.SSH_USER }}
        SSH_HOST: ${{ secrets.SSH_HOST }}
        CASINO_TOKEN: ${{ secrets.CASINO_TOKEN }}
        POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
        POSTGRES_PASSWD: ${{ secrets.POSTGRES_PASSWD }}
        DISCORD_WEBHOOK_ALERT: ${{ secrets.DISCORD_WEBHOOK_ALERT }}
        MY_DISCORD_UID: ${{ secrets.MY_DISCORD_UID }}
      run: |
        ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST << EOF
          set -e

          echo "Navigating to project directory..."
          cd /home/$SSH_USER/discord-bots/casino

          echo "Fetching latest changes..."
          git fetch --all
          git reset --hard origin/main

          echo "Rebuilding and restarting only 'casino-bot' service..."
          CASINO_TOKEN="$CASINO_TOKEN" \
          POSTGRES_USER="$POSTGRES_USER" \
          POSTGRES_PASSWD="$POSTGRES_PASSWD" \
          docker compose -f casino/docker_conf/casino-postgres-docker-compose.yml \
            --project-directory . \
            up --build -d casino-bot

          echo "Checking bot status..."
          EXIT_CODE=\$(docker inspect --format='{{.State.ExitCode}}' casino-bot)

          if [ "\$EXIT_CODE" -ne 0 ]; then
            echo "âŒ Casino bot failed with code \$EXIT_CODE"
            curl -X POST -H "Content-Type: application/json" \
              -d "{\"content\": \"ðŸš¨ <@$MY_DISCORD_UID> Casino Bot failed to restart!\"}" \
              $DISCORD_WEBHOOK_ALERT
            exit 1
          fi

          echo "âœ… Casino Bot successfully redeployed!"
        EOF
