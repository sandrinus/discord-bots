name: Auto-Deploy Discord Bot

on:
  push:
    branches:
      - main
    paths:
      - 'casino/**'
  workflow_dispatch:

jobs:
  deploy:
    name: Build & Run Docker on Remote Machine
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Start SSH Agent & Add Key
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: SSH into machine and deploy
      env:
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          DISCORD_TOKEN: ${{ secrets.CASINO_TOKEN }}
      run: |
        ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST << EOF

          set -e

          echo "Navigating to bot directory..."
          cd /home/$SSH_USER/discord-bots/casino

          echo "Pulling latest changes from main..."
          git fetch --all
          git reset --hard origin/main

          echo "Building updated Docker image..."
          docker build -t casino-bot-image -f dockerfile .
          docker image prune -f

          echo "Stopping and removing old container..."
          docker stop casino-bot || true
          docker rm casino-bot || true

          echo "Starting new container..."
          docker run -d \
          --name casino-bot \
          --restart unless-stopped \
          -v /home/$SSH_USER/discord-bots/casino/casino.db:/app/casino.db \
          -e CASINO_TOKEN=$DISCORD_TOKEN \
          -i casino-bot-image
          
          echo "âœ… Bot deployed and running!"
        EOF
