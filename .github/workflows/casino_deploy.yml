name: Auto-Deploy Discord Bot

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Build & Run Docker on Remote Machine
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Start SSH Agent & Add Key
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: SSH into machine and deploy
      run: |
        USER=${{ secrets.SSH_USER }}
        HOST=${{ secrets.SSH_HOST }}
        ssh -o StrictHostKeyChecking=no $USER@$HOST << 'EOF'

          set -e

          echo "Navigating to bot directory..."
          cd /home/$USER/discord-bots

          echo "Pulling latest changes from main..."
          git pull origin main --rebase --force

          echo "Building updated Docker image..."
          docker build -t casino-bot-image -f dockerfile .

          echo "Stopping and removing old container..."
          docker stop casino-bot || true
          docker rm casino-bot || true

          echo "Starting new container..."
          docker run -d --name casino-bot --restart unless-stopped -v /home/$USER/discord-bots/casino/casino.db:/app/casino.db -i casino-bot-image

          echo "âœ… Bot deployed and running!"
        EOF
